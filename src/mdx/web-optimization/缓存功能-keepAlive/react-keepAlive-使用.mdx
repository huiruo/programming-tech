
```js
import { isKeepAliveRoute, useKeepAliveRouter } from "@/hooks/useKeepAliveRouter"

  const { navigateToCache } = useKeepAliveRouter()

  const handleClickCallback = (href: string, needLogin = false) => {
    const normalized = normalizePath(href)

    if (needLogin && !isLoggedIn()) {
      setIsShowLoginDrawer({ showLoginDrawer: true, isSwitchLogin: true })
      return
    }

    if (href === "/") {
      taskEventUpApi({
        event: "get_activity_event",
        metadata: "",
      })
    }

    if (isKeepAliveRoute(normalized)) {
      // SPA å†…åˆ‡æ¢ç¼“å­˜é¡µé¢
      navigateToCache(normalized)
    } else {
      // éç¼“å­˜é¡µé¢ï¼Œæ™®é€šè·³è½¬
      router.push(href)
    }
  }
```

## KeepAlive å·²ç»åšåˆ° Next.js éå®˜æ–¹é«˜é˜¶ç©æ³•
å®æ—¶ä¸Šåœ¨layout ä¸€ä¸ªæ–‡ä»¶å°±å¯ä»¥å®ç°ç¼“å­˜åŠŸèƒ½äº†
```js
./keepAlive/index.tsx
```

åŸç†ï¼š
ä½ ä¸æ˜¯åœ¨â€œç¼“å­˜è·¯ç”±â€ï¼Œè€Œæ˜¯åœ¨â€œç¼“å­˜ React ç»„ä»¶å®ä¾‹ + DOMâ€ï¼Œé€šè¿‡ display: none æŠŠä¸ç”¨çš„é¡µé¢è—èµ·æ¥ï¼Œè€Œä¸æ˜¯å¸è½½å®ƒã€‚

è¿™å°±æ˜¯æ‰€è°“çš„ å‰ç«¯ KeepAlive

### æ­£å¸¸ Next.js è·¯ç”±åˆ‡æ¢
```
/promotion â†’ /deposit

reactè¡Œä¸º
Promotion Component  unmount âŒ
Deposit Component     mount  âœ…

- state å…¨æ²¡
- scrollTop å½’é›¶
- è¯·æ±‚é‡æ–°å‘
```

### ä½ ç°åœ¨çš„ KeepAlive:
DOM æ²¡è¢«é”€æ¯ï¼Œåªæ˜¯ éšè—ã€‚
```
/promotion â†’ /deposit

React å®é™…è¡Œä¸ºï¼š

Promotion Component   ä¿ç•™åœ¨å†…å­˜ä¸­ï¼ˆdisplay: noneï¼‰
Deposit Component     mount
```

## ä½ è¿™å¥— KeepAlive çš„æ ¸å¿ƒæœºåˆ¶ï¼ˆé€è¡Œæ‹†ï¼‰
1. ç¼“å­˜å®¹å™¨ = Map,è¿™ä¸€æ­¥ç›¸å½“äºï¼š ã€Œæˆ‘åœ¨å†…å­˜é‡Œç»´æŠ¤ä¸€ä¸ªè·¯ç”± â†’ ReactElement çš„æ˜ å°„è¡¨ã€
```js
const [cachedComponents, setCachedComponents] =
  useState<Map<string, CachedComponent>>(new Map())
```

2. å½“å‰è·¯ç”±ä½œä¸º keyï¼ˆéå¸¸å…³é”®ï¼‰
```js
const currentPath =
  router.pathname === "/" ? "/" : `${router.pathname}/`
```

3. shouldCache = æ˜¯å¦è¿›å…¥ KeepAlive
```js
const shouldCache = (pathname: string) =>
  cacheRoutes.some(route =>
    route.endsWith('*')
      ? pathname.startsWith(route.slice(0, -1))
      : pathname === route
  )

æœ¬è´¨æ˜¯ï¼š

1. ç™½åå•

2. ç²¾ç¡®åŒ¹é… or å‰ç¼€åŒ¹é…

3. åªæœ‰åœ¨ç™½åå•é‡Œçš„è·¯ç”±ï¼Œæ‰ä¼šè¿›å…¥ç¼“å­˜ç³»ç»Ÿ
```

### 4. useEffectï¼šå†³å®šã€Œå»ºç¼“å­˜ / ç”¨ç¼“å­˜ / åˆ·æ–°ç¼“å­˜ã€
è¿™é‡Œæ˜¯æ•´ä¸ª KeepAlive çš„å¿ƒè„

1. æ²¡ç¼“å­˜ â†’ æ–°å»ºç»„ä»¶å®ä¾‹

2. æœ‰ç¼“å­˜ä¸”æœªè¿‡æœŸ â†’ ç»§ç»­ç”¨åŸæ¥çš„ ReactElement

3. è¿‡æœŸ â†’ å½»åº•é‡å»ºï¼ˆç­‰åŒ unmount + mountï¼‰
```js
useEffect(() => {
  if (!shouldCache(currentPath)) return

  setCachedComponents(prev => {
    const newCache = new Map(prev)
    const existing = newCache.get(currentPath)

    if (!existing || isCacheExpired(existing.timestamp)) {
      // â—æ–°å»º or è¿‡æœŸ â†’ é‡æ–° mount
      newCache.set(currentPath, {
        pathname: currentPath,
        component: <Component {...pageProps} key={currentPath} />,
        timestamp: Date.now()
      })
    } else {
      // âœ… å‘½ä¸­ç¼“å­˜ â†’ æ›´æ–°æ—¶é—´
      newCache.set(currentPath, {
        ...existing,
        timestamp: Date.now()
      })
    }

    return newCache
  })
}, [currentPath])
```

## 5. æ¸²æŸ“é˜¶æ®µï¼šçœŸæ­£â€œéª—è¿‡ Reactâ€
è¿™é‡Œå‘ç”Ÿäº†å…³é”®çš„äº‹:
æ‰€æœ‰ç¼“å­˜é¡µé¢éƒ½åŒæ—¶å­˜åœ¨äº React æ ‘ä¸­

```
åªæ˜¯ï¼š

å½“å‰é¡µé¢ï¼šdisplay: block
å…¶ä»–é¡µé¢ï¼šdisplay: none
```

- ğŸ‘‰ React ä¸ä¼š unmount
- ğŸ‘‰ DOMã€stateã€scrollã€ref å…¨ä¿ç•™

```js
{Array.from(cachedComponents.entries()).map(([pathname, cached]) => {
  const isActive = pathname === currentPath

  return (
    <div
      key={pathname}
      style={{ display: isActive ? 'block' : 'none', height: '100%' }}
    >
      {cached.component}
    </div>
  )
})}
```

## 6.å…œåº•æ¸²æŸ“ï¼ˆéç¼“å­˜è·¯ç”±ï¼‰
å¦‚æœå½“å‰è·¯ç”±ï¼š

1. ä¸åœ¨ç™½åå•
2. æˆ–è¿˜æ²¡è¿›å…¥ç¼“å­˜

å°±èµ° æ™®é€šæ¸²æŸ“
```js
{!cachedComponents.has(currentPath) &&
  <Component {...pageProps} key={currentPath} />
}
```

## è¿™å¥— KeepAlive é€‚åˆä»€ä¹ˆåœºæ™¯ï¼Ÿ
- é¦–é¡µæ¸¸æˆåˆ—è¡¨
- promotion é¡µ
- æ»šåŠ¨éå¸¸é‡
- è¯·æ±‚éå¸¸å¤š
- è¿”å›ä½“éªŒè¦æ±‚æé«˜


## A.å’Œvue3 çš„ keep alive
- Vue 3 çš„ `<KeepAlive>` æ˜¯â€œæ¡†æ¶çº§ç”Ÿå‘½å‘¨æœŸæ§åˆ¶â€
- React / Next.js çš„ KeepAlive æ˜¯â€œç”¨æˆ·æ€ DOM + ç»„ä»¶å®ä¾‹ç¼“å­˜â€
```
| å¯¹æ¯”ç‚¹          | Vue 3 `<KeepAlive>`           | ä½ è¿™å¥— React KeepAlive |
| ------------ | ----------------------------- | ------------------- |
| æ˜¯å¦å®˜æ–¹æ”¯æŒ       | âœ… æ˜¯ï¼ˆå†…å»ºï¼‰                       | âŒ å¦ï¼ˆæ‰‹å†™ï¼‰             |
| æ˜¯å¦çœŸçš„ unmount | âŒ ä¸å¸è½½                         | âŒ ä¸å¸è½½               |
| ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥       | âœ… æœ‰ `activated / deactivated` | âŒ æ²¡æœ‰                |
| ç¼“å­˜ç²’åº¦         | ç»„ä»¶çº§                           | è·¯ç”±çº§ï¼ˆä½ å®ç°çš„ï¼‰           |
| æ§åˆ¶æ–¹å¼         | å£°æ˜å¼                           | å‘½ä»¤å¼                 |
| å®ç°éš¾åº¦         | ä½                             | é«˜                   |
| å‡ºé”™æ¦‚ç‡         | ä½                             | é«˜                   |
```

Vue ä¸æ˜¯ç®€å• display:none,æŠŠç»„ä»¶ä»çœŸå® DOM æ ‘ä¸­ç§»é™¤ï¼Œä½†ä¿ç•™åœ¨å†…å­˜çš„ VNode æ ‘é‡Œ
```
1. DOM èŠ‚ç‚¹è¢«ç¼“å­˜
2. ç»„ä»¶å®ä¾‹è¢«ç¼“å­˜
3. watcher / reactive è¿˜æ´»ç€

Vue ç¨³çš„åŸå› ï¼š

1. KeepAlive æ˜¯ç¼–è¯‘æœŸ + runtime çº§åˆ«æ”¯æŒ

2. è·¯ç”±ç³»ç»Ÿå’Œ KeepAlive æ·±åº¦è€¦åˆ

3. æœ‰ activated / deactivated é’©å­å…œåº•

å®˜æ–¹å¤„ç†äº†ï¼š

å¤šå±‚åµŒå¥—

include / exclude

max LRU

async component
```

Vue æœ‰ä¸“å±ç”Ÿå‘½å‘¨æœŸï¼ˆReact æ²¡æœ‰ï¼‰
```js
onActivated(() => {
  // é¡µé¢â€œè¢«å”¤é†’â€
})

onDeactivated(() => {
  // é¡µé¢â€œè¢«å†·å†»â€
})

æ¨¡æ‹Ÿï¼š
useEffect(() => {
  if (isActive) {
    onActivated?.()
  } else {
    onDeactivated?.()
  }
}, [isActive])
```

### React KeepAlive æœ¬è´¨æ˜¯åœ¨â€œéª— Reactâ€
React çš„è§†è§’æ˜¯ï¼š â€œå“¦ï¼Œè¿™äº›ç»„ä»¶ä¸€ç›´éƒ½åœ¨ï¼Œé‚£æˆ‘å°±ä¸ç®¡äº†â€
```js
{
  allCachedPages.map(page => (
    <div style={{ display: isActive ? 'block' : 'none' }}>
      <PageComponent />
    </div>
  ))
```

### ä¸¤è€…â€œç­‰ä»·â€çš„åœ°æ–¹ï¼ˆä¸ºä»€ä¹ˆä½ ä¼šè§‰å¾—åƒï¼‰
ä¸¤è€…ç¡®å®åœ¨å¹²åŒä¸€ä»¶äº‹ï¼š é˜»æ­¢ç»„ä»¶ unmountï¼Œä»è€Œä¿ç•™ state + DOM

æ‰€ä»¥åœ¨ç”¨æˆ·ä½“éªŒå±‚é¢ï¼š
```
æ»šåŠ¨æ¡
è¡¨å•è¾“å…¥
å·²åŠ è½½æ•°æ®
æ•ˆæœå‡ ä¹ä¸€æ ·ã€‚
```